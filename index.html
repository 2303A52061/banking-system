import React, { useState, useEffect } from "react";
import { PieChart, Pie, Cell, Tooltip } from "recharts";

/******************* OBSERVER PATTERN *******************/
class NotificationCenter {
  constructor() {
    this.subscribers = [];
  }
  subscribe(callback) {
    this.subscribers.push(callback);
  }
  notify(message) {
    this.subscribers.forEach((cb) => cb(message));
  }
}
const notificationCenter = new NotificationCenter();

/******************* STRATEGY PATTERN *******************/
const EMIStrategies = {
  flatRate: (amount, rate, term) =>
    ((amount * rate * term) / 100 + amount) / (term * 12),
  reducingBalance: (amount, rate, term) => {
    let monthlyRate = rate / 12 / 100;
    return (
      (amount * monthlyRate * Math.pow(1 + monthlyRate, term * 12)) /
      (Math.pow(1 + monthlyRate, term * 12) - 1)
    );
  },
};

/******************* COMMAND PATTERN *******************/
class CommandInvoker {
  constructor() {
    this.history = [];
  }
  execute(command) {
    command.execute();
    this.history.push(command);
  }
  undo() {
    const command = this.history.pop();
    if (command) command.undo();
  }
}
class ApproveLoanCommand {
  constructor(loan, setLoans) {
    this.loan = loan;
    this.setLoans = setLoans;
  }
  execute() {
    this.setLoans((prev) =>
      prev.map((l) =>
        l.id === this.loan.id ? { ...l, status: "Approved" } : l
      )
    );
    notificationCenter.notify(`Loan ${this.loan.id} Approved.`);
  }
  undo() {
    this.setLoans((prev) =>
      prev.map((l) => (l.id === this.loan.id ? { ...l, status: "Pending" } : l))
    );
  }
}
class RejectLoanCommand {
  constructor(loan, setLoans) {
    this.loan = loan;
    this.setLoans = setLoans;
  }
  execute() {
    this.setLoans((prev) =>
      prev.map((l) =>
        l.id === this.loan.id ? { ...l, status: "Rejected" } : l
      )
    );
    notificationCenter.notify(`Loan ${this.loan.id} Rejected.`);
  }
  undo() {
    this.setLoans((prev) =>
      prev.map((l) => (l.id === this.loan.id ? { ...l, status: "Pending" } : l))
    );
  }
}
const invoker = new CommandInvoker();

/******************* FACTORY PATTERN *******************/
class AccountFactory {
  static createAccount(type, balance) {
    switch (type) {
      case "Savings":
        return { type, balance, interest: 4 };
      case "Current":
        return { type, balance, overdraft: true };
      case "FD":
        return { type, balance, lockIn: 12 };
      case "RD":
        return { type, balance, monthly: true };
      default:
        return { type: "General", balance };
    }
  }
}

/******************* STATE PATTERN *******************/
class LoanState {
  constructor(name) {
    this.name = name;
  }
  next() {}
}
class PendingState extends LoanState {
  constructor() {
    super("Pending");
  }
  next() {
    return new ApprovedState();
  }
}
class ApprovedState extends LoanState {
  constructor() {
    super("Approved");
  }
  next() {
    return new DisbursedState();
  }
}
class DisbursedState extends LoanState {
  constructor() {
    super("Disbursed");
  }
  next() {
    return new ClosedState();
  }
}
class ClosedState extends LoanState {
  constructor() {
    super("Closed");
  }
}

/******************* MAIN APP *******************/
export default function BankingApp() {
  const [userType, setUserType] = useState(null);
  const [notifications, setNotifications] = useState([]);
  const [loans, setLoans] = useState([]);
  const [accounts] = useState([AccountFactory.createAccount("Savings", 10000)]);
  const [expenses, setExpenses] = useState([
    { category: "Food", amount: 3000 },
    { category: "Transport", amount: 1500 },
    { category: "Bills", amount: 2000 },
  ]);

  useEffect(() => {
    notificationCenter.subscribe((msg) =>
      setNotifications((prev) => [...prev, msg])
    );
  }, []);

  const applyLoan = (amount, rate, term, type) => {
    const newLoan = {
      id: loans.length + 1,
      amount,
      rate,
      term,
      type,
      status: "Pending",
      state: new PendingState(),
    };
    setLoans([...loans, newLoan]);
    notificationCenter.notify(`New ${type} loan applied.`);
  };

  /******** Bill Payments ********/
  const [bills, setBills] = useState([]);
  const payBill = (type, amount) => {
    const receipt = {
      id: bills.length + 1,
      type,
      amount,
      date: new Date().toLocaleString(),
    };
    setBills([...bills, receipt]);
    notificationCenter.notify(`${type} bill of ‚Çπ${amount} paid.`);
  };

  /******** FD Calculator ********/
  const calcFD = (amount, rate, years) =>
    amount * Math.pow(1 + rate / 100, years);

  return (
    <div>
      <h1>üè¶ Banking Application</h1>

      {!userType && (
        <div>
          <button onClick={() => setUserType("user")}>Login as User</button>
          <button onClick={() => setUserType("admin")}>Login as Admin</button>
        </div>
      )}

      {userType === "user" && (
        <div>
          <div className="card">
            <h2>Apply Loan</h2>
            <button onClick={() => applyLoan(50000, 10, 2, "Home")}>
              Apply Home Loan
            </button>
          </div>

          <div className="card">
            <h2>Bill Payments</h2>
            <button onClick={() => payBill("Electricity", 1500)}>
              Pay Electricity
            </button>
            <button onClick={() => payBill("Mobile", 500)}>Pay Mobile</button>
            <ul>
              {bills.map((b) => (
                <li key={b.id}>
                  {b.type} ‚Çπ{b.amount} ({b.date})
                </li>
              ))}
            </ul>
          </div>

          <div className="card">
            <h2>FD Calculator</h2>
            <p>
              ‚Çπ10,000 for 3 years @ 6% ‚Üí ‚Çπ{calcFD(10000, 6, 3).toFixed(0)}
            </p>
          </div>

          <div className="card">
            <h2>Spending Analytics</h2>
            <PieChart width={300} height={200}>
              <Pie
                data={expenses}
                dataKey="amount"
                nameKey="category"
                outerRadius={80}
              >
                {expenses.map((entry, index) => (
                  <Cell
                    key={`cell-${index}`}
                    fill={["#8884d8", "#82ca9d", "#ffc658"][index]}
                  />
                ))}
              </Pie>
              <Tooltip />
            </PieChart>
          </div>
        </div>
      )}

      {userType === "admin" && (
        <div>
          <h2>Admin Loan Management</h2>
          {loans.map((loan) => (
            <div className="card" key={loan.id}>
              <p>
                Loan {loan.id}: {loan.type} ‚Çπ{loan.amount} ({loan.status})
              </p>
              <button
                onClick={() =>
                  invoker.execute(new ApproveLoanCommand(loan, setLoans))
                }
              >
                Approve
              </button>
              <button
                onClick={() =>
                  invoker.execute(new RejectLoanCommand(loan, setLoans))
                }
              >
                Reject
              </button>
            </div>
          ))}
          <button onClick={() => invoker.undo()}>Undo Last Action</button>
        </div>
      )}

      <div className="card">
        <h2>Notifications</h2>
        <ul>
          {notifications.map((n, i) => (
            <li key={i}>{n}</li>
          ))}
        </ul>
      </div>
    </div>
  );
}
